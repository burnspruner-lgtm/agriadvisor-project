<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agriadvisor (V-MAX)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: #d1d5db; border-radius: 0.375rem; transition: all 0.2s ease; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background-color: #1d4ed8; color: white; }
        .nav-link i { margin-right: 0.75rem; width: 1.25rem; }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .stat-card { padding: 1.5rem; }
        .stat-title { font-size: 0.875rem; font-weight: 500; color: #6b7280; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #111827; }
        [data-role] { display: none; }
        input[type=range] { /* ... (slider styles) ... */ }
        .auth-container { display: none; align-items: center; justify-content: center; min-height: 100vh; background-color: #1f2937; }
        .auth-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 2rem; width: 24rem; }
        .auth-tab { padding: 0.5rem 1rem; font-weight: 600; cursor: pointer; color: #6b7280; border-bottom: 2px solid transparent; }
        .auth-tab.active { color: #1d4ed8; border-bottom-color: #1d4ed8; }
    </style>
</head>
<body class="flex h-screen">

    <div id="auth-page" class="auth-container absolute z-50 w-screen h-screen">
        <div class="auth-card">
            <h1 class="text-3xl font-bold text-center mb-2">üåæ Agriadvisor</h1>
            <p class="text-gray-600 text-center mb-6">V-MAX Secure System</p>
            
            <div class="flex border-b mb-6">
                <button id="tab-login" class="auth-tab active">Login</button>
                <button id="tab-register" class="auth-tab">Register</button>
            </div>
            
            <div id="login-form-container">
                <form id="login-form">
                    <input id="login-username" type="text" placeholder="Username" class="w-full p-3 border rounded mb-4" required>
                    <input id="login-password" type="password" placeholder="Password" class="w-full p-3 border rounded mb-4" required>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700">Login</button>
                    <div id="login-error" class="text-red-500 mt-4 text-center"></div>
                </form>
            </div>
            
            <div id="register-form-container" class="hidden">
                <form id="register-form">
                    <input id="register-username" type="text" placeholder="Username" class="w-full p-3 border rounded mb-4" required>
                    <input id="register-password" type="password" placeholder="Password" class="w-full p-3 border rounded mb-4" required>
                    <p class="text-sm text-gray-500 mb-4">All new accounts are registered as a standard 'User'. An admin can promote your account.</p>
                    <button type="submit" class="w-full bg-gray-700 text-white p-3 rounded font-semibold hover:bg-gray-600">Register</button>
                    <div id="register-message" class="mt-4 text-center"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="app-shell" class="flex h-screen w-screen hidden">
        <nav class="w-64 bg-gray-800 text-white flex-shrink-0 p-4 flex flex-col">
            <h1 class="text-2xl font-bold mb-6">Agriadvisor</h1>
            <div id="sidebar-nav" class="space-y-2 flex-grow"></div>
            <div class="border-t border-gray-700 pt-4">
                <div id="user-profile" class="text-gray-400">
                    <p class="font-semibold" id="user-name">Not Logged In</p>
                    <p class="text-sm" id="user-role">No Role</p>
                </div>
                <button id="logout-button" class="w-full text-left nav-link mt-2"><i class="fa-solid fa-sign-out-alt"></i>Logout</button>
            </div>
        </nav>
        <main class="flex-1 flex flex-col h-screen">
            <header class="bg-white border-b border-gray-200 p-3 flex justify-end items-center space-x-6">
                <div><span class="stat-title">Heartbeat:</span> <span id="heartbeat" class="stat-value text-xs text-red-600 ml-2">OFFLINE</span></div>
                <div data-role="developer" data-role-admin><span class="stat-title">Safety Lock:</span> <span id="safety-lock-status" class="stat-value text-xs text-gray-500 ml-2">N/A</span></div>
                <button id="btn-trigger-ai" data-role="admin" data-role-user class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">
                    <i class="fa-solid fa-play mr-2"></i>Run Global AI Decision
                </button>
            </header>
            <div class="flex-1 p-6 overflow-y-auto">
                <h2 id="page-title" class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                <div id="page-dashboard" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="stat-card card"><span class="stat-title">Agent Health</span><div id="agent-health" class="stat-value">N/A</div></div>
                        <div class="stat-card card"><span class="stat-title">Agent Uptime</span><div id="agent-uptime" class="stat-value">N/A</div></div>
                        <div class="stat-card card"><span class="stat-title">Total Decisions</span><div id="total-decisions" class="stat-value">N/A</div></div>
                    </div>
                    <div class="card mt-6">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-4">Sensor Data Input</h3>
                            <form id="data-form" class="grid grid-cols-2 md:grid-cols-4 gap-6 p-4">
                                <div><label class="font-semibold">Field ID</label><input type="text" id="field-id" value="Maize-Field-01" class="w-full p-2 border rounded" required></div>
                                <div><label class="font-semibold">Nutrient Level</label><select name="nutrient_level" class="w-full p-2 border rounded"><option>OPTIMAL</option><option>LOW</option><option>HIGH</option><option>N/A</option></select></div>
                                <div><label class="font-semibold">Historical Trend</label><select name="historical_trend" class="w-full p-2 border rounded"><option>NORMAL</option><option>HIGH_INTERVENTION</option></select></div>
                                <div><label class="font-semibold">Cost (KES)</label><input type="number" name="cost_kes" value="1000" class="w-full p-2 border rounded"></div>
                                <div><label class="font-semibold">Moisture (<span id="val-moisture">65</span>%)</label><input type="range" name="moisture" min="0" max="100" value="65" class="w-full slider" oninput="this.previousElementSibling.textContent = this.value"></div>
                                <div><label class="font-semibold">Temp (<span id="val-temp">25</span>¬∞C)</label><input type="range" name="temp" min="0" max="50" value="25" class="w-full slider" oninput="this.previousElementSibling.textContent = this.value"></div>
                                <div><label class="font-semibold">Pump Pressure (psi)</label><input type="number" name="pump_pressure" value="70" class="w-full p-2 border rounded"></div>
                                <div><label class="font-semibold">Wind Speed (kph)</label><input type="number" name="wind_speed" value="15" class="w-full p-2 border rounded"></div>
                                <div><label class="font-semibold">Solar Radiation (W/m¬≤)</label><input type="number" name="solar_radiation" value="850" class="w-full p-2 border rounded"></div>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="page-ai_chat" class="page" data-role="user" data-role-admin>
                    <div class="card p-4">
                        <h3 class="text-lg font-semibold mb-4">Interact with Agriadvisor AI</h3>
                        <div id="chat-window" class="h-96 border rounded-lg p-4 overflow-y-auto bg-gray-50 mb-4">
                            <div class="text-gray-700 mb-2 p-3 rounded-lg bg-gray-200 w-3/4">Hello! Ask me a question, like "Explain rule R001" or "What is your confidence in the irrigation pump?"</div>
                        </div>
                        <form id="chat-form" class="flex">
                            <input id="chat-input" type="text" class="flex-grow p-3 border rounded-l-lg" placeholder="Type your question...">
                            <button type="submit" class="bg-blue-600 text-white p-3 rounded-r-lg font-semibold hover:bg-blue-700">Send</button>
                        </form>
                    </div>
                </div>
                <div id="page-soil_analysis" class="page card p-6" data-role="user" data-role-admin><h2 class="text-xl font-semibold mb-4">üß™ Soil & Crop Analysis</h2><div id="content-soil">...</div></div>
                <div id="page-location_intel" class="page card p-6" data-role="user" data-role-admin><h2 class="text-xl font-semibold mb-4">üìç Location Intel</h2><div id="content-location">...</div></div>
                <div id="page-ml_insights" class="page card p-6" data-role="admin"><h2 class="text-xl font-semibold mb-4">ü§ñ ML Insights</h2><div id="content-insights">...</div></div>
                <div id="page-ai_heuristics" class="page card p-6" data-role="maintenance" data-role-admin><h2 class="text-xl font-semibold mb-4">üß† AI Learning & Heuristics</h2><pre id="content-heuristics">Loading AI memory...</pre></div>
                <div id="page-admin_panel" class="page card p-6" data-role="admin">
                    <h2 class="text-xl font-semibold mb-4">üîê Admin Panel: User Management</h2>
                    <div id="user-management-table" class="overflow-x-auto">Loading user list...</div>
                </div>
                <div id="page-system_logs" class="page card p-6" data-role="developer" data-role-maintenance data-role-admin><h2 class="text-xl font-semibold mb-4">üêû System Log (Developer)</h2><div id="logs" class="h-96 bg-gray-900 text-white p-3 rounded-lg overflow-y-auto font-mono text-xs"></div></div>
            </div>
        </main>
    </div>

<script>
    // --- THIS IS THE "FULLY FLEDGED" JAVASCRIPT ---
    
    const API_URL = 'http://127.0.0.1:5000';
    let charts = {};
    let userRole = null;
    
    // --- 1. Element References (Unchanged) ---
    const elements = {
        authPage: document.getElementById('auth-page'),
        appShell: document.getElementById('app-shell'),
        logs: document.getElementById('logs'),
        heartbeat: document.getElementById('heartbeat'),
        safetyLock: document.getElementById('safety-lock-status'),
        agentHealth: document.getElementById('agent-health'),
        agentUptime: document.getElementById('agent-uptime'),
        totalDecisions: document.getElementById('total-decisions'),
        dataForm: document.getElementById('data-form'),
        fieldIdInput: document.getElementById('field-id'),
        modal: document.getElementById('modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalClose: document.getElementById('modal-close'),
        pageTitle: document.getElementById('page-title'),
        sidebarNav: document.getElementById('sidebar-nav'),
        userName: document.getElementById('user-name'),
        userRole: document.getElementById('user-role'),
        chat: { window: document.getElementById('chat-window'), form: document.getElementById('chat-form'), input: document.getElementById('chat-input') },
        pageContents: {
            soil_analysis: document.getElementById('content-soil'),
            location_intel: document.getElementById('content-location'),
            ml_insights: document.getElementById('content-insights'),
            ai_heuristics: document.getElementById('content-heuristics'),
            admin_panel: document.getElementById('user-management-table')
        },
        loginForm: document.getElementById('login-form'),
        loginError: document.getElementById('login-error'),
        loginUsername: document.getElementById('login-username'),
        loginPassword: document.getElementById('login-password'),
        registerForm: document.getElementById('register-form'),
        registerMessage: document.getElementById('register-message'),
        registerUsername: document.getElementById('register-username'),
        registerPassword: document.getElementById('register-password'),
        tabLogin: document.getElementById('tab-login'),
        tabRegister: document.getElementById('tab-register'),
        loginFormContainer: document.getElementById('login-form-container'),
        registerFormContainer: document.getElementById('register-form-container'),
        logoutButton: document.getElementById('logout-button')
    };
    const pages = document.querySelectorAll('.page');
    
    // --- 2. Role-Based Navigation & UI (Unchanged) ---
    const navConfig = {
        dashboard: '<a href="#dashboard" class="nav-link"><i class="fa-solid fa-tachometer-alt"></i>Dashboard</a>',
        ai_chat: '<a href="#ai_chat" class="nav-link"><i class="fa-solid fa-comments"></i>Interact with AI</a>',
        soil_analysis: '<a href="#soil_analysis" class="nav-link"><i class="fa-solid fa-flask"></i>Soil Analysis</a>',
        location_intel: '<a href="#location_intel" class="nav-link"><i class="fa-solid fa-satellite-dish"></i>Location Intel</a>',
        ml_insights: '<a href="#ml_insights" class="nav-link"><i class="fa-solid fa-brain"></i>ML Insights</a>',
        ai_heuristics: '<a href="#ai_heuristics" class="nav-link"><i class="fa-solid fa-microchip"></i>AI Heuristics</a>',
        admin_panel: '<a href="#admin_panel" class="nav-link"><i class="fa-solid fa-users-cog"></i>Admin Panel</a>',
        system_logs: '<a href="#system_logs" class="nav-link"><i class="fa-solid fa-bug"></i>System Logs</a>'
    };
    const rolePermissions = {
        user: ['dashboard', 'ai_chat', 'soil_analysis', 'location_intel'],
        admin: ['dashboard', 'admin_panel', 'ai_chat', 'soil_analysis', 'location_intel', 'ml_insights', 'ai_heuristics', 'system_logs'],
        maintenance: ['dashboard', 'ai_heuristics', 'system_logs'],
        developer: ['dashboard', 'admin_panel', 'ai_chat', 'soil_analysis', 'location_intel', 'ml_insights', 'ai_heuristics', 'system_logs']
    };
    function applyRoles(role) {
        elements.sidebarNav.innerHTML = '';
        rolePermissions[role].forEach(pageId => {
            elements.sidebarNav.innerHTML += navConfig[pageId];
        });
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); showPage(e.currentTarget.hash.substring(1)); });
        });
        
        // This logic is now fixed and correct
        const userAccess = rolePermissions[role];
        document.querySelectorAll('[data-role]').forEach(el => {
            // Check if ANY of the element's data-role attributes are in the user's access list
            const roles = Object.keys(el.dataset);
            const hasAccess = roles.some(r => userAccess.includes(el.dataset[r]));

            if (hasAccess) {
                 el.style.display = 'block';
            } else {
                 el.style.display = 'none';
            }
        });
        
        // Special case for header buttons
        document.querySelectorAll('#app-shell header [data-role]').forEach(el => {
            const hasAccess = rolePermissions[role].includes(el.dataset.role) || 
                              rolePermissions[role].includes(el.dataset.roleAdmin) ||
                              rolePermissions[role].includes(el.dataset.roleUser);
            if (hasAccess) el.style.display = 'block';
        });

        showPage('dashboard');
    }

    // --- 3. Auth Page Logic (UPDATED) ---
    
    // Tab switching (Unchanged)
    elements.tabLogin.addEventListener('click', () => {
        elements.tabLogin.classList.add('active');
        elements.tabRegister.classList.remove('active');
        elements.loginFormContainer.classList.remove('hidden');
        elements.registerFormContainer.classList.add('hidden');
    });
    elements.tabRegister.addEventListener('click', () => {
        elements.tabRegister.classList.add('active');
        elements.tabLogin.classList.remove('active');
        elements.registerFormContainer.classList.remove('hidden');
        elements.loginFormContainer.classList.add('hidden');
    });
    
    // Handle Registration (UPDATED)
    elements.registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = elements.registerUsername.value;
        const password = elements.registerPassword.value;
        elements.registerMessage.textContent = "Registering...";
        elements.registerMessage.className = "mt-4 text-center text-gray-500";
        try {
            const response = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            elements.registerMessage.textContent = data.message;
            elements.registerMessage.className = "mt-4 text-center text-green-500";
            elements.tabLogin.click();
        } catch (error) {
            elements.registerMessage.textContent = `Error: ${error.message}`;
            elements.registerMessage.className = "mt-4 text-center text-red-500";
        }
    });
    
    // Handle Login (UPDATED)
    elements.loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = elements.loginUsername.value;
        const password = elements.loginPassword.value;
        elements.loginError.textContent = "";
        try {
            const response = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            startFullApp(data.username, data.role);
        } catch (error) {
            elements.loginError.textContent = `Error: ${error.message}`;
        }
    });

    // Handle Logout (UPDATED)
    elements.logoutButton.addEventListener('click', async () => {
        await fetch(`${API_URL}/api/logout`, { method: 'POST', credentials: 'include' }); // <-- BUG FIX
        window.location.reload();
    });

    // --- 4. Main App Initialization ---
    
    function startFullApp(username, role) {
        userRole = role;
        elements.userName.textContent = username;
        elements.userRole.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        elements.authPage.style.display = 'none';
        elements.appShell.classList.remove('hidden');
        applyRoles(userRole);
        startAppServices();
    }
    
    // On page load, check for an existing session (UPDATED)
    async function checkSession() {
        try {
            const response = await fetch(`${API_URL}/api/check_session`, { credentials: 'include' }); // <-- BUG FIX
            const data = await response.json();
            if (data.is_logged_in) {
                startFullApp(data.username, data.role);
            } else {
                elements.authPage.style.display = 'flex';
            }
        } catch (e) {
            elements.authPage.style.display = 'flex';
            elements.loginError.textContent = "Cannot connect to server. Is it running?";
        }
    }

    // --- 5. Logging, Modal, SPA (UPDATED) ---
    function log(message, type = 'INFO') {
        elements.logs.innerHTML += `<div class="${{ 'FATAL': 'text-red-500', 'ERROR': 'text-red-400', 'SUCCESS': 'text-green-400', 'REQUEST': 'text-yellow-400', 'INFO': 'text-gray-300' }[type] || 'text-gray-300'}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
        elements.logs.scrollTop = elements.logs.scrollHeight;
    }
    function showModal(title, jsonData) { /* ... (unchanged) ... */ }
    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        const link = document.querySelector(`a[href="#${pageId}"]`);
        if(link) {
            elements.pageTitle.textContent = link.textContent.trim();
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
        } else { elements.pageTitle.textContent = "Dashboard"; }
        
        // Auto-run features
        if (pageId === 'admin_panel') runAdminPanel();
        if (pageId === 'ml_insights') runFeature('ml_insights', 'api/ml_insights', 'ML Insights', buildInsightsReport);
        if (pageId === 'ai_heuristics') runFeature('ai_heuristics', 'api/heuristics', 'AI Heuristics', buildHeuristicsReport);
    }
    
    // --- 6. API Calls (Heartbeat, Form Data, Features) (UPDATED) ---
    async function fetchHeartbeat() {
        try {
            const response = await fetch(`${API_URL}/status`, { credentials: 'include' }); // <-- BUG FIX
            const data = await response.json();
            elements.heartbeat.textContent = new Date(data.agent_status.timestamp * 1000).toLocaleTimeString();
            elements.heartbeat.className = 'stat-value text-xs text-green-600 ml-2';
            elements.safetyLock.textContent = data.safety_lock ? 'Active' : 'INACTIVE (BREACH!)';
            elements.safetyLock.className = data.safety_lock ? 'stat-value text-xs text-green-600 ml-2' : 'stat-value text-xs text-red-600 ml-2 animate-pulse';
            const status = data.agent_deep_status;
            elements.agentHealth.textContent = status.agent_health_status;
            elements.agentUptime.textContent = `${status.uptime_seconds.toFixed(1)}s`;
            elements.totalDecisions.textContent = status.total_decisions;
        } catch (error) { 
            log(`Heartbeat failed: ${error.message}`, 'FATAL');
            elements.heartbeat.textContent = 'OFFLINE';
            elements.heartbeat.className = 'stat-value text-xs text-red-600 ml-2';
        }
    }
    function getFormData() { /* ... (unchanged) ... */ }
    
    // --- 7. Feature Logic (Global AI, Chat, etc) (UPDATED) ---
    document.getElementById('btn-trigger-ai').addEventListener('click', async () => {
        const payload = getFormData();
        log(`Triggering Full Heuristic AI for ${payload.field_id}...`, 'REQUEST');
        showPage('dashboard');
        try {
            const response = await fetch(`${API_URL}/api/process_full_ai`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            log(`[SUCCESS] AI Action: ${data.ai_action}`, 'SUCCESS');
            log(`[FEEDBACK] Tool Success: ${data.execution_result.success}`, 'INFO');
            showModal('Full AI Response (with Learning Feedback)', data);
        } catch (error) { log(`[ERROR] AI Trigger failed: ${error.message}`, 'ERROR'); }
    });
    
    elements.chat.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = elements.chat.input.value;
        if (!query) return;
        addChatMessage(query, 'user');
        elements.chat.input.value = '';
        try {
            const response = await fetch(`${API_URL}/api/ai_chat`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: JSON.stringify({ query: query })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.answer);
            addChatMessage(data.answer, 'ai');
        } catch (error) { addChatMessage(`Error: ${error.message}`, 'ai'); }
    });
    function addChatMessage(message, sender) { /* ... (unchanged) ... */ }

    // Helper for other pages
    async function runFeature(pageId, apiEndpoint, title, buildFunction) {
        const payload = getFormData();
        log(`Running ${title} for ${payload.field_id}...`, 'REQUEST');
        const contentEl = elements.pageContents[pageId];
        contentEl.innerHTML = '<div class="text-gray-500">Loading...</div>';
        try {
            const response = await fetch(`${API_URL}/${apiEndpoint}`, {
                method: (apiEndpoint.includes('GET')) ? 'GET' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: (apiEndpoint.includes('GET')) ? null : JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            contentEl.innerHTML = buildFunction(data);
            activateCharts(pageId, data);
        } catch (error) {
            log(`[ERROR] ${title} failed: ${error.message}`, 'ERROR');
            contentEl.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
        }
    }
    
    // --- 8. Beautifier Functions (UPDATED) ---
    function buildSoilReport(data) { /* ... */ }
    function buildLocationReport(data) { /* ... */ }
    function buildInsightsReport(data) { /* ... */ }
    function buildHeuristicsReport(data) { /* ... */ }
    function buildAdminPanel(users) {
        let html = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">User ID</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Current Role</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Set Role</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
        users.forEach(user => {
            html += `<tr>
                        <td class="px-4 py-2 text-sm">${user.id}</td>
                        <td class="px-4 py-2 text-sm font-semibold">${user.username}</td>
                        <td class="px-4 py-2 text-sm">${user.role}</td>
                        <td class="px-4 py-2 text-sm">
                            <select data-user-id="${user.id}" class="p-1 border rounded role-select">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="maintenance" ${user.role === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="developer" ${user.role === 'developer' ? 'selected' : ''}>Developer</option>
                            </select>
                        </td></tr>`;
        });
        html += `</tbody></table>`;
        elements.pageContents.admin_panel.innerHTML = html;
        document.querySelectorAll('.role-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const userId = e.target.dataset.userId;
                const newRole = e.target.value;
                promoteUser(userId, newRole);
            });
        });
    }
    
    // --- NEW: Admin Panel API Calls (UPDATED) ---
    async function runAdminPanel() {
        try {
            const response = await fetch(`${API_URL}/api/admin/get_users`, { credentials: 'include' }); // <-- BUG FIX
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            buildAdminPanel(data);
        } catch (error) {
            log(`[ERROR] Failed to get users: ${error.message}`, 'ERROR');
            elements.pageContents.admin_panel.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
        }
    }
    async function promoteUser(user_id, new_role) {
        try {
            const response = await fetch(`${API_URL}/api/admin/promote_user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // <-- BUG FIX
                body: JSON.stringify({ user_id: user_id, new_role: new_role })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            log(`[SUCCESS] User ${user_id} role changed to ${new_role}`, 'SUCCESS');
            runAdminPanel(); // Refresh the table
        } catch (error) { log(`[ERROR] Failed to promote user: ${error.message}`, 'ERROR'); }
    }

    // --- 9. Chart Drawing Function (Unchanged) ---
    function activateCharts(pageId, data) { /* ... */ }

    // --- 10. Initial App Start (Called after login) ---
    function startAppServices() {
        setInterval(fetchHeartbeat, 3000);
        fetchHeartbeat();
        log('Agriadvisor "V-MAX Secure" Dashboard Initialized.', 'INFO');
    }
    
    // --- START: Check session on page load ---
    checkSession();
</script>
</body>
</html>